<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Feedback & Teacher Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        let app;
        let db;
        let auth;
        let userId = 'loading...';
        let isAuthReady = false; // Flag to indicate authentication readiness

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Ensure firebaseConfig is always provided, even with placeholder values if __firebase_config is missing
        const firebaseConfig = typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "YOUR_API_KEY", // Replace with an actual API Key if you deploy outside Canvas
                authDomain: `${appId}.firebaseapp.com`,
                projectId: appId, // Use appId as projectId fallback
                storageBucket: `${appId}.appspot.com`,
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // Replace with actual ID
                appId: "YOUR_APP_ID" // Replace with actual App ID
            };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const chatMessagesCollection = (uid) => collection(db, `/artifacts/${appId}/public/data/chat_messages`);
        const feedbackCollection = (uid) => collection(db, `/artifacts/${appId}/public/data/feedback`);

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM Content Loaded. Initializing Firebase...");
            console.log("Firebase Config:", firebaseConfig);

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase App and Services initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('current-user-id').textContent = `Your Anonymous ID: ${userId.substring(0, 8)}...`;
                        isAuthReady = true; // Auth is ready
                        console.log("Authentication state changed: User logged in. UID:", userId);
                        setupChatListener(); // Setup listener only when auth is ready
                    } else {
                        console.log("Authentication state changed: No user. Attempting sign-in...");
                        if (initialAuthToken) {
                            console.log("Signing in with custom token...");
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            console.log("Signing in anonymously...");
                            await signInAnonymously(auth);
                        }
                    }
                }, (error) => {
                    console.error("onAuthStateChanged error:", error);
                    document.getElementById('current-user-id').textContent = `Auth Error: ${error.message}`;
                });

                const feedbackForm = document.getElementById('feedbackForm');
                const feedbackMessageDiv = document.getElementById('feedbackMessage');
                feedbackForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!isAuthReady || !auth.currentUser) {
                        feedbackMessageDiv.textContent = 'Authentication not complete. Please wait...';
                        feedbackMessageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                        feedbackMessageDiv.classList.add('bg-yellow-100', 'text-yellow-800');
                        console.warn("Feedback submission blocked: Authentication not ready.");
                        return;
                    }

                    const studentName = document.getElementById('studentName').value;
                    const subject = document.getElementById('subject').value;
                    const teacherName = document.getElementById('teacherName').value;
                    const feedbackText = document.getElementById('feedbackText').value;

                    try {
                        await addDoc(feedbackCollection(auth.currentUser.uid), {
                            studentName: studentName || 'Anonymous',
                            subject: subject,
                            teacherName: teacherName,
                            feedback: feedbackText,
                            timestamp: serverTimestamp(),
                            userId: auth.currentUser.uid
                        });
                        feedbackForm.reset();
                        feedbackMessageDiv.textContent = 'Feedback submitted successfully!';
                        feedbackMessageDiv.classList.remove('hidden', 'bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-red-800');
                        feedbackMessageDiv.classList.add('bg-green-100', 'text-green-800');
                        setTimeout(() => feedbackMessageDiv.classList.add('hidden'), 5000);
                        console.log("Feedback submitted successfully.");
                    } catch (error) {
                        console.error("Error adding feedback: ", error);
                        feedbackMessageDiv.textContent = 'Error submitting feedback. Please try again.';
                        feedbackMessageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800');
                        feedbackMessageDiv.classList.add('bg-red-100', 'text-red-800');
                    }
                });

                const chatInput = document.getElementById('chatInput');
                const sendMessageBtn = document.getElementById('sendMessageBtn');
                const chatMessagesDiv = document.getElementById('chatMessages');

                const sendMessage = async () => {
                    const messageText = chatInput.value.trim();
                    if (messageText === '') return;

                    if (!isAuthReady || !auth.currentUser) {
                         chatInput.value = 'Authentication not complete. Cannot send message.';
                         console.warn("Chat message blocked: Authentication not ready.");
                         return;
                    }

                    try {
                        await addDoc(chatMessagesCollection(auth.currentUser.uid), {
                            userId: userId,
                            message: messageText,
                            timestamp: serverTimestamp()
                        });
                        chatInput.value = '';
                        console.log("Message sent.");
                    } catch (error) {
                        console.error("Error sending message: ", error);
                    }
                };

                sendMessageBtn.addEventListener('click', sendMessage);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });

                function setupChatListener() {
                    if (!isAuthReady || !auth.currentUser) {
                        console.warn("Attempted to setup chat listener before authentication was ready.");
                        return;
                    }
                    console.log("Setting up chat listener...");
                    const q = query(chatMessagesCollection(auth.currentUser.uid), orderBy('timestamp'));
                    onSnapshot(q, (snapshot) => {
                        console.log("New chat messages snapshot received.");
                        chatMessagesDiv.innerHTML = '';
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const messageElement = document.createElement('div');
                            messageElement.classList.add('mb-2', 'p-3', 'rounded-lg', 'break-words');
                            if (data.userId === userId) {
                                messageElement.classList.add('bg-blue-100', 'ml-auto', 'text-right', 'rounded-br-none');
                                messageElement.innerHTML = `<p class="font-semibold text-blue-800">You (Anonymous):</p><p>${data.message}</p>`;
                            } else {
                                messageElement.classList.add('bg-gray-100', 'rounded-bl-none');
                                messageElement.innerHTML = `<p class="font-semibold text-gray-800">Anonymous User (${data.userId.substring(0, 8)}...):</p><p>${data.message}</p>`;
                            }
                            chatMessagesDiv.appendChild(messageElement);
                        });
                        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                    }, (error) => {
                        console.error("Error listening to chat messages: ", error);
                    });
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('current-user-id').textContent = `Error: ${error.message}`;
            }
        });
    </script>
    <!-- Chosen Palette: Calm Harmony (Light neutrals for background, soft blue/green for accents) -->
    <!-- Application Structure Plan: The application is structured as a single-page layout divided into two primary, clearly distinct sections: a "Student Feedback Form" and a "Teacher Chat" area. This design was chosen to group related functionalities logically, allowing users to quickly access either task without navigating to separate pages. The form is presented first as a primary input mechanism, followed by the chat for real-time interaction. This linear flow simplifies the user journey for two distinct but related activities within a single browser session. -->
    <!-- Visualization & Content Choices:
        - Report Info: Student Feedback Data. Goal: Collect structured input. Viz/Presentation: HTML form elements (text inputs, textarea). Interaction: Standard form submission with local validation and success messages (data will be persisted via Firebase). Justification: A traditional form is the most efficient and universally understood method for collecting structured feedback. Library: Vanilla JS for form handling, Firebase Firestore for data persistence.
        - Report Info: Teacher Chat Communication. Goal: Enable real-time, text-based conversation across multiple users. Viz/Presentation: A scrollable message display area and a text input for sending messages. Interaction: Messages are sent by typing and pressing Enter or clicking a send button, and new messages appear automatically in real-time for all connected users. Justification: Provides a familiar and intuitive chat experience, with messages persisted and synchronized through Firebase Firestore. Library: Vanilla JS for UI updates, Firebase Firestore for real-time data synchronization, Firebase Auth for anonymous user identification.
        - Report Info: User identification. Goal: Inform the user of their unique anonymous identifier for chat. Viz/Presentation: Plain text display of a truncated anonymous ID. Interaction: None, informational. Justification: Essential for distinguishing 'your' messages from 'other anonymous users' in the real-time chat. Library: Vanilla JS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Light neutral background */
            color: #374151; /* Dark gray text */
        }
        input[type="text"],
        textarea {
            border: 1px solid #d1d5db; /* Light gray border */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #60a5fa; /* Soft blue focus */
        }
        button {
            background-color: #3b82f6; /* Medium blue */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #2563eb; /* Darker blue on hover */
        }
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Student Hub: Feedback & Chat</h1>
            <p class="mt-4 text-lg text-gray-600">Provide feedback or connect with teachers in real-time.</p>
        </header>

        <main class="grid grid-cols-1 gap-12">
            <section id="feedback-form-section" class="bg-white p-6 md:p-8 rounded-2xl shadow-sm">
                <h2 class="text-2xl font-bold mb-6 text-center">Student Feedback Form</h2>
                <p class="text-gray-600 mb-6 text-center">Use this form to provide anonymous or named feedback on your subjects and teachers. Your input helps us improve!</p>
                <form id="feedbackForm" class="space-y-6">
                    <div>
                        <label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Your Name (Optional)</label>
                        <input type="text" id="studentName" placeholder="e.g., Jane Doe" class="w-full">
                    </div>
                    <div>
                        <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                        <input type="text" id="subject" placeholder="e.g., Chemistry 101" required class="w-full">
                    </div>
                    <div>
                        <label for="teacherName" class="block text-sm font-medium text-gray-700 mb-1">Teacher's Name</label>
                        <input type="text" id="teacherName" placeholder="e.g., Dr. Smith" required class="w-full">
                    </div>
                    <div>
                        <label for="feedbackText" class="block text-sm font-medium text-gray-700 mb-1">Your Feedback</label>
                        <textarea id="feedbackText" rows="5" placeholder="Share your thoughts..." required class="w-full"></textarea>
                    </div>
                    <button type="submit" class="w-full justify-center flex items-center">Submit Feedback</button>
                    <div id="feedbackMessage" class="hidden mt-4 p-3 rounded-md text-sm font-medium text-center"></div>
                </form>
            </section>

            <section id="teacher-chat-section" class="bg-white p-6 md:p-8 rounded-2xl shadow-sm">
                <h2 class="text-2xl font-bold mb-6 text-center">Anonymous Real-time Chat</h2>
                <p class="text-gray-600 mb-6 text-center">Chat anonymously with other users. Messages will be visible to everyone and persist across sessions.</p>
                <div class="mb-4 text-sm text-gray-500 font-medium" id="current-user-id">Signing in anonymously...</div>
                <div id="chatMessages" class="chat-messages mb-4 rounded-lg flex flex-col">
                    <p class="text-center text-gray-400">Loading messages...</p>
                </div>
                <div class="flex space-x-3">
                    <input type="text" id="chatInput" placeholder="Type your message..." class="flex-grow rounded-xl">
                    <button id="sendMessageBtn" class="flex-shrink-0">Send</button>
                </div>
            </section>
        </main>
    </div>

</body>
</html>
